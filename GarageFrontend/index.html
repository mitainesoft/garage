<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <!--<meta name="generator" content="Responsive Site Designer 1.5.1390">-->
    <title>Mitaine Garage</title>

    <!--<script src="../js/jquery-3.2.1.js"></script>-->
    <!--<script src="../js/jquery.mobile-1.4.5.min.js"></script>-->

    <link rel="stylesheet" href="../css/coffeegrinder.min.css">
    <link rel="stylesheet" href="../css/wireframe-theme.min.css">
    <link rel="stylesheet" href="../css/main.css">

    <!--<link href="http://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" type="text/css"/>-->
    <link rel="stylesheet" href="../css/flaticon.css">


    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <!--<script>document.createElement("picture");</script>-->
    <!--<script src="../js/picturefill.min.js" class="picturefill" async="async"></script>-->

</head>

<body>

<div data-role="page" id="foo" class="row NavPicture">

    <div data-role="header">

        <div class="coffee-span-12 coffee-670-span-12">
            <h1 class="MainTitle">Mitaine Garage</h1>
            <h3>Anti-Mule Systeme</h3>
        </div>
        <div data-role="navbar">
            <ul>
                <li><a class="flaticon-font glyphs-icon glyph flaticon-house-3 ui-btn-active" href="index.html"></a></li>
                <li><a class="flaticon-font glyphs-icon glyph flaticon-cctv" href="index.html"></a></li>
                <li><a class="flaticon-font glyphs-icon glyph flaticon-info" href="about.html"></a></li>
            </ul>

        </div>

    </div><!-- /header -->

    <div role="main" class="ui-content coffee-span-12 call-out">
        <!--opendoorbutton errordoorbutton unknownstatusdoorbutton closeddoorbutton -->

        <a id="garagecmd0" class="link-button nav-button flaticon-garage" href="#"
           onclick="proceed('trigger','0');">0</a>

        <a id="garagecmd1" class="link-button nav-button flaticon-garage" href="#"
           onclick="proceed('trigger','1');">1</a>

        <br></br>

        <!--<h1 class="MainTitle3">Alertes</h1>-->
        <a id="alertclear" class="link-button nav-button flaticon-garbage" href="#" onclick="proceed('clear','0');">Alarmes</a>
        <a id="alertlist" class="link-button nav-button flaticon-info" href="#" onclick="displayAlert();"></a>

    </div><!-- /content -->


    <div data-role="footer">
        <div class="coffee-span-12"><a href="#" target="_blank" class="social-image socialicon"><img
                class="facebook-icon" src="../socialicons/webicon-facebook.png" alt="Social Icon"></a><a href="#"
                                                                                                         target="_blank"
                                                                                                         class="social-image socialicon"><img
                class="instagram-icon" src="../socialicons/webicon-instagram.png" alt="Social Icon"></a><a href="#"
                                                                                                           target="_blank"
                                                                                                           class="social-image socialicon"><img
                class="twitter-icon" src="../socialicons/webicon-twitter.png" alt="Social Icon"></a><a href="#"
                                                                                                       target="_blank"
                                                                                                       class="social-image socialicon"><img
                class="googleplus-icon" src="../socialicons/webicon-googleplus.png" alt="Social Icon"></a><a
                href="#"
                target="_blank"
                class="social-image socialicon"><img
                class="linkedin-icon" src="../socialicons/webicon-linkedin.png" alt="Social Icon"></a>
        </div>

        <div class="coffee-span-12">
            <p class="paragraph Footer">Ile-Bizard<br>(514) 594 3818 mitainesoft@gmail.com</p>
            <p class="paragraph FooterCredit"><span <a title="Mitainesoft" href="http://www.github.com/mitainesoft/"
                                                       class="p-link">Mitainesoft</a></span>
            </p>
        </div>
    </div><!-- /footer -->

    <script>
        var intervalEvent = setInterval(doorStatus, 60000);
        window.onload = function () {
            doorStatus();
            intervalEvent = setInterval(doorStatus, 30000);
        }


        $(window).on("blur focus", function (e) {
            var prevType = $(this).data("prevType");

            if (prevType != e.type) {   //  reduce double fire issues
                switch (e.type) {
                    case "blur":
                        clearInterval(intervalEvent);
                        break;
                    case "focus":
                        intervalEvent = setInterval(doorStatus, 7000);
                        break;
                }
            }

            $(this).data("prevType", e.type);
        })

        function proceed(subcmd, id) {

            var labelstr = "garagecmd" + id;
            var prevstatus = "UNKNOWN";
            var status = "UNKNOWN";
            var alertlistArray = null;

            switch (true) {
                case /^clear/.test(subcmd):
                    $('#alertlist').removeClass('errordoorbutton');
                    $('#alertclear').removeClass('errordoorbutton');
                    $('#alertclear').removeClass('link-butto');
                    $('#alertclear').removeClass('nav-button');
                    $('#alertclear').removeClass('flaticon-garbage');
                    break;
                case /^trigger/.test(subcmd):
                    /* Check current button status to make sure status of
                     door was correct in the UI especially if operations are
                     done remote!
                     */
                    <!--opendoorbutton errordoorbutton unknownstatusdoorbutton closeddoorbutton -->
                    if ($('#garagecmd' + id).hasClass('closeddoorbutton')) {
                        prevstatus = "CLOSED";
                        subcmd = "open";
                        console.log("Command is now 'open'!");
                    } else if ($('#garagecmd' + id).hasClass('opendoorbutton')) {
                        prevstatus = "OPEN";
                        subcmd = "close";
                        console.log("Command is now 'close'!");
                    } else {
                        console.log("proceed::Door will not be trigger denied ! ");
                        alert("Door will not be trigger denied ! ");
                        return;
                    }

                    //Check real door status
                    doorStatus();
                    var status = "UNKNOWN";
                    if ($('#garagecmd' + id).hasClass('closeddoorbutton')) {
                        status = "CLOSED";
                    } else if ($('#garagecmd' + id).hasClass('opendoorbutton')) {
                        status = "OPEN";
                    } else {
                        console.log("proceed::Door will not be triggered due to current status UNKNOWN or ERROR!");
                        alert("Door will not be triggered due to current status UNKNOWN or ERROR!");
                        return;
                    }

                    if (status !== prevstatus) {
                        console.log("proceed::Door will not be triggered due to UI display not refreshed!  Try again ! ");
                        alert("Door will not be triggered due to UI display not refreshed!  Try again ! ");

                        return;
                    } else {

                    }
                    break;

                default:
                    console.log("proceed::Invalid command:" + subcmd)
                    break;

            } //switch

            var cmd = 'http://192.168.1.83:8050/GarageDoor/' + subcmd + '/' + id
            var posting = $.post(cmd, function (data) {
                parseResponse(data);
            })

        }

        function doorStatus() {
            for (count = 0; count <= 1; count++) {
                cmd = 'http://192.168.1.83:8050/GarageDoor/status/' + count
                garageid = "garagestatus" + count;
                posting = $.post(cmd, function (data) {
                    parseResponse(data, status)
                }, null, "text")
            }
        }

        function parseResponse(data) {
            console.log("-- parseResponse -------------------------------------------------------\n");
            if (data == null) return;
            tmpstr = data.toString();
            var myArray = tmpstr.match(/tid\:(\d+)\s+(\[DeviceManager\])\s+(\w+)\:(\w+)\s+tid\:(\d+)\s+\[AlertManager\]\s(\w+)\=(.*)/);

//            console.log("'" + tmpstr + "'\n");
            if (myArray == null) return;

            console.log("array:" + myArray + "\n")
            for (var i = 0; i <= 7; i++) {
                console.log(i + ":" + myArray[i] + "\n");
            }


            /*  0:tid:00001498254616977432 [DeviceManager] GARAGE_0:CLOSED tid:00000000001498254616 [AlertManager] Alertlist=None
             1:00001498254616977432
             2:[DeviceManager]
             3:GARAGE_0
             4:CLOSED
             5:00000000001498254616
             6:Alertlist
             7:None */
            var labelstr = "";
            if (/\[DeviceManager\]/.test(myArray[2])) {

                switch (true) {
                    case /GARAGE/.test(myArray[3]):
                        <!--opendoorbutton errordoorbutton unknownstatusdoorbutton closeddoorbutton -->
                        var deviceArray = myArray[3].split('_');
                        if (deviceArray == null || deviceArray.length !== 2) {
                            console.log("parseResponse::Invalid Device format returned by backend server:" + myArray[2]);
                            return;
                        }
                        deviceid = deviceArray[1];
                        //garagestatus1
                        labelstr = "garagecmd" + deviceArray[1];
                        clearClassGarage(labelstr);
                        console.log("parseResponse::labelstr=" + labelstr);
//                        $('#' + labelstr).removeClass('unknownstatusdoorbutton');
                        switch (true) {
                            case /^CLOSED/.test(myArray[4]):
                                $('#' + labelstr).addClass('closeddoorbutton');
                                break;
                            case /^OPEN/.test(myArray[4]):
                                $('#' + labelstr).addClass('opendoorbutton');
                                break;
                            case /^ERROR/.test(myArray[4]):
                                $('#' + labelstr).addClass('errordoorbutton');
                                break;
                            case /^UNKNOWN/.test(myArray[4]):
                                $('#' + labelstr).addClass('unknownstatusdoorbutton');
                                break;
                            default:
                                $('#' + labelstr).addClass('programerrorbutton');
                                console.log("parseResponse Unknown status:" + myArray[4]);
                                break;
                        }
                        break;
                    default:
                        console.log("parseResponse::Unknown device command:" + tmpstr);
                        break;
                }
            } //if device

            /*   7:Alert id:GCD01 dev:GARAGE_0 sev:1 cat:GARAGE_LOCK text:Fermeture automatique déactivé workaround:Verifiez la porte et les logs!
             time:20170624-092526 ;Alert id:HW002 dev:GARAGE_0 sev:1 cat:HARDWARE text:Command sent but nothing happened! workaround:Check
             the door ! time:20170624-092508 ;Alert id:GS001 dev:GARAGE_0_sensor_1 sev:1 cat:SENSOR text:problème avec un senseur sur la porte
             workaround:La fermeture est peut-être bloquée par de la neige ou un des senseurs ne fonctionne plus! time:20170624-092526
             */
            if (myArray[7] == null) {
                console.log("Alert list is null. (" + tmpstr + ")");
            }

            alertlistArray = myArray[7].split(';');
            if (alertlistArray.length <= 0) {
                alertlistArray[0] = myArray[7];
            }

            if (/^None/.test(alertlistArray[0])) {
                console.log("No Alerts!");
                clearAlerts();
                alertlistArray = null;
                //link-button nav-button flaticon-garbage
            } else {
                for (var i = 0; i < alertlistArray.length; i++) {
                    console.log(i + ":" + alertlistArray[i] + "\n");
                }
                //Enable alert buttons
                colorAlertButton();
            }
        }

        function clearClassGarage(labelid) {
            $('#' + labelid).removeClass('opendoorbutton');
            $('#' + labelid).removeClass('errordoorbutton');
            $('#' + labelid).removeClass('closeddoorbutton');
            $('#' + labelid).removeClass('unknownstatusdoorbutton');
        }

        function clearAlerts() {
            $('#alertlist').removeClass('errordoorbutton');
            $('#alertclear').removeClass('errordoorbutton');
            $('#alertclear').removeClass('link-butto');
            $('#alertclear').removeClass('nav-button');
            $('#alertclear').removeClass('flaticon-garbage');
        }

        function colorAlertButton() {
            $('#alertlist').addClass('errordoorbutton');
            $('#alertclear').addClass('errordoorbutton');
            $('#alertclear').addClass('link-butto');
            $('#alertclear').addClass('nav-button');
            $('#alertclear').addClass('flaticon-garbage');
        }

        function displayAlert() {
            if (alertlistArray == null) {
                console.log("displayAlert is null !");
            } else {
                alerttxt="";
                for (var i = 0; i < alertlistArray.length; i++) {
                    alerttxt=alerttxt+ i + ":" + alertlistArray[i] + "\n";
                }
                alert(alerttxt);
            }
        }
    </script>
</div><!-- /page -->
</body>

</html>